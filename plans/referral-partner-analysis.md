# Анализ реферальной и партнерской систем

## Дата анализа: 2026-02-02

---

## 1. РЕФЕРАЛЬНАЯ СИСТЕМА В БОТЕ (altshop)

### 1.1 Общее описание

Реферальная система в боте — это **внутренняя система вознаграждений** для обычных пользователей за приглашение друзей. Она работает на уровне отношений пользователь-пользователь без денежных выплат.

### 1.2 Ключевые компоненты

**Модели данных** (`referral.py`):
- `Referral` — связь между referrer (кто пригласил) и referred (кто пришел)
- `ReferralReward` — записи о начисленных вознаграждениях
- Поддерживает многоуровневую структуру (1-3 уровня)

**Настройки** (в `ReferralSettingsDto`):
- `enable` — включена/выключена
- `level` — максимальный уровень рефералов (1, 2 или 3)
- `reward.type` — тип вознаграждения: POINTS (баллы) или EXTRA_DAYS (дни подписки)
- `reward.strategy` — AMOUNT (фиксированная сумма) или PERCENT (процент)
- `accrual_strategy` — ON_FIRST_PAYMENT или ON_EACH_PAYMENT
- `eligible_plan_ids` — фильтр по тарифам

### 1.3 Типы вознаграждений

1. **Баллы (POINTS)** — внутренняя валюта
2. **Дни подписки (EXTRA_DAYS)** — продление подписки

### 1.4 Обмен баллов (Points Exchange)

Система позволяет обменивать накопленные баллы на:
- Дни подписки (`SUBSCRIPTION_DAYS`)
- Подарочную подписку (`GIFT_SUBSCRIPTION`)
- Скидку на покупку (`DISCOUNT`)
- Дополнительный трафик (`TRAFFIC`)

Каждый тип обмена имеет настройки:
- `points_cost` — стоимость в баллах
- `min_points` / `max_points` — лимиты
- Дополнительные параметры (макс. скидка, длительность подарка и т.д.)

### 1.5 Уровни рефералов

```python
class ReferralLevel(IntEnum):
    FIRST = 1   # Прямой реферал
    SECOND = 2  # Реферал реферала
    THIRD = 3   # Реферал реферала реферала
```

### 1.6 Кому доступна

Доступна **всем пользователям** бота. Каждый пользователь имеет реферальный код и может приглашать друзей.

---

## 2. ПАРТНЕРСКАЯ СИСТЕМА В БОТЕ (altshop)

### 2.1 Общее описание

Партнерская программа — это **монетизированная система** для активных партнеров с выплатами реальных денег. Требует активации статуса "партнер".

### 2.2 Ключевые компоненты

**Модели данных** (`partner.py`):
- `Partner` — профиль партнера со статусом, балансом, статистикой
- `PartnerTransaction` — начисления процента от оплат рефералов
- `PartnerWithdrawal` — запросы на вывод средств
- `PartnerReferral` — связь партнер-реферал с уровнем

**Настройки** (в `PartnerSettingsDto`):
- `enabled` — включена/выключена программа
- `level1_percent`, `level2_percent`, `level3_percent` — комиссии по уровням
- `tax_percent` — налог на выплаты
- `min_withdrawal_amount` — минимальная сумма вывода (в копейках)
- Комиссии платежных систем: `yookassa_commission`, `cryptopay_commission`, и т.д.

### 2.3 Механика начислений

1. Партнер получает **процент от каждой оплаты** реферала
2. Процент зависит от уровня реферала:
   - Уровень 1: `level1_percent`%
   - Уровень 2: `level2_percent`%
   - Уровень 3: `level3_percent`%
3. Сумма начисляется в копейках/центах на баланс партнера

### 2.4 Вывод средств

- Минимальная сумма вывода настраивается админом
- Партнер создает запрос на вывод
- Админ одобряет/отклоняет через дашборд
- Статусы: PENDING, COMPLETED, REJECTED, CANCELED

### 2.5 Кому доступна

Только пользователям с **активированным статусом партнера**. Не все пользователи автоматически являются партнерами.

---

## 3. СРАВНИТЕЛЬНАЯ ТАБЛИЦА: РЕФЕРАЛЬНАЯ vs ПАРТНЕРСКАЯ

| Критерий | Реферальная система | Партнерская программа |
|----------|---------------------|----------------------|
| **Цель** | Вовлечение пользователей | Монетизация через партнеров |
| **Вознаграждение** | Баллы / дни подписки | Деньги (процент от оплат) |
| **Уровни** | До 3 уровней | До 3 уровней |
| **Кто участвует** | Все пользователи | Только активированные партнеры |
| **Вывод средств** | Нет (только обмен баллов) | Да, реальные деньги |
| **Управление** | Настройки правил | Управление выплатами, комиссии |
| **Админ-панель** | Настройка типов вознаграждений | Управление заявками на вывод |

---

## 4. АНАЛИЗ РЕАЛИЗАЦИИ В PANEL

### 4.1 Текущая структура

**Реферальные таблицы** (015_create_referral_rules.sql):
- `referral_earnings` — история начислений по уровням
- `referral_levels` — статистика по уровням для каждого пользователя
- `top_referrers` — кэш топа рефереров
- `referral_points_exchange` — обмен баллов

**Партнерские таблицы** (016_create_partner_levels.sql):
- `partner_levels` — уровни партнеров (Новичок, Активный, Профи...)
- `partner_referral_details` — детальный трекинг рефералов
- `partner_conversion` — ежедневная статистика конверсии
- `partner_monthly_stats` — агрегированная месячная статистика

### 4.2 Компоненты интерфейса

**Реферальные** (`src/components/referrals/`):
- `ReferralTree` — древо рефералов
- `ReferralLevelCard` — карточка статистики по уровню
- `ReferralHistoryTable` — история начислений
- `ReferralRulesDisplay` — отображение правил
- `PointsExchangeForm` — форма обмена баллов
- `TopReferrersList` — список топ рефереров

**Партнерские** (`src/components/partner/`):
- `PartnerStatsCards` — карточки статистики партнера
- `PartnerEarningsChart` — график доходов
- `PartnerConversionStats` — статистика конверсии
- `PartnerEarningsTable` — таблица начислений
- `PartnerPayoutsTable` — таблица выплат
- `PartnerReferralTable` — таблица рефералов партнера

### 4.3 Страницы

- `ClientReferrals.tsx` — страница реферальной программы
- `ClientPartner.tsx` — партнерский кабинет

---

## 5. ВЫЯВЛЕННЫЕ НЕСООТВЕТСТВИЯ И ПРОБЛЕМЫ

### 5.1 Критические несоответствия

| Проблема | Описание | Уровень |
|----------|----------|---------|
| **Перепутанные концепции** | В panel компоненты referrals содержат функциональность partner ( earnings, payouts ) и наоборот | Критический |
| **Смешение уровней** | `ReferralLevelCard` показывает "комиссию" в %, что свойственно партнерке, а не рефералке | Высокий |
| **Дублирование** | Оба раздела показывают "рефералов" и "заработок" — функционально пересекаются | Средний |

### 5.2 Детальное объяснение перепутанности

**Что сделано неправильно в panel:**

1. **ReferralHistoryTable** показывает:
   - Статусы: pending, approved, paid, cancelled
   - Типы: direct, level2, level3, bonus
   - Это похоже на партнерские начисления, а не реферальные баллы

2. **ReferralLevelCard** показывает:
   - "Комиссия X%" — но в боте рефералка работает на баллах/днях, не процентах!
   - "Заработок" в валюте — рефералка не дает денег

3. **PartnerEarningsTable** показывает:
   - commissionRate — это правильно для партнерки
   - Но структура дублирует ReferralHistoryTable

### 5.3 Правильная структура

**Реферальная система (ClientReferrals) должна показывать:**
- Количество приглашенных друзей
- Накопленные баллы (points)
- История начисления баллов (не денег!)
- Обмен баллов на дни/скидки/трафик
- Древо рефералов (иерархия)
- Правила получения баллов

**Партнерская программа (ClientPartner) должна показывать:**
- Баланс в деньгах (рубли/доллары)
- Комиссии по уровням (%)
- История начислений денег
- Запросы на вывод
- Статистику конверсии (clicks → sales)
- Уровень партнера (Новичок → Легенда)

---

## 6. РЕКОМЕНДАЦИИ ПО ИСПРАВЛЕНИЮ

### 6.1 Разделение концепций

```
РЕФЕРАЛЬНАЯ СИСТЕМА (для всех пользователей)
├── Баллы (points) - внутренняя валюта
├── Обмен баллов на бонусы
├── Древо рефералов (3 уровня)
└── История баллов (не денег!)

ПАРТНЕРСКАЯ ПРОГРАММА (только для партнеров)
├── Баланс в деньгах
├── Комиссии % с продаж
├── Вывод средств
├── Статистика конверсии
└── Уровни партнера
```

### 6.2 Исправления компонентов

**ReferralHistoryTable** → должен показывать:
- Начисление баллов (не денег)
- Тип: за регистрацию, за покупку реферала
- Сколько баллов получено
- Дата

**ReferralLevelCard** → должен показывать:
- Количество рефералов на уровне
- Сколько баллов заработано с этого уровня
- Без процентов и "комиссий"!

**PartnerEarningsTable** → правильно, оставить как есть:
- Денежные начисления
- Комиссия в %
- Статус: pending/approved/paid

### 6.3 Данные в БД

**referral_levels** (для рефералок):
- Убрать `commission_rate` — рефералка не про деньги
- Добавить `points_earned`, `referrals_count`

**partner_levels** (для партнерки):
- Правильно — commission_rate, min_referrals, min_earnings

### 6.4 Сценарии использования

**Сценарий 1: Обычный пользователь**
1. Открывает ClientReferrals
2. Видит свои баллы
3. Видит сколько друзей пригласил
4. Меняет баллы на дни подписки
5. НЕ видит денег и выводов

**Сценарий 2: Партнер**
1. Открывает ClientPartner
2. Видит свой баланс в рублях
3. Видит комиссии по уровням
4. Создает запрос на вывод
5. Видит статистику конверсии

---

## 7. ВЫВОДЫ

### 7.1 Главная проблема

В текущей реализации panel **смешаны две разные системы**:
1. Реферальная — для вовлечения (баллы, бонусы)
2. Партнерская — для монетизации (деньги, выплаты)

### 7.2 Что нужно сделать

1. **Отделить данные**: Рефералка = баллы, Партнерка = деньги
2. **Исправить компоненты**: Убрать "комиссии" из реферальных компонентов
3. **Правильная терминология**:
   - Рефералка: баллы, обмен, дни подписки
   - Партнерка: комиссия, выплата, конверсия

4. **Доступ**: 
   - Рефералка доступна всем
   - Партнерка только активированным партнерам

### 7.3 Правильная архитектура

```
┌─────────────────────────────────────┐
│         ВСЕ ПОЛЬЗОВАТЕЛИ            │
│    ┌─────────────────────────┐      │
│    │   РЕФЕРАЛЬНАЯ СИСТЕМА   │      │
│    │  • Баллы за приглашения │      │
│    │  • Обмен на бонусы      │      │
│    │  • Древо рефералов      │      │
│    └─────────────────────────┘      │
└─────────────────────────────────────┘
                  
┌─────────────────────────────────────┐
│      ТОЛЬКО ПАРТНЕРЫ                │
│    ┌─────────────────────────┐      │
│    │   ПАРТНЕРСКАЯ ПРОГРАММА │      │
│    │  • % с продаж           │      │
│    │  • Вывод денег          │      │
│    │  • Статистика CTR       │      │
│    └─────────────────────────┘      │
└─────────────────────────────────────┘
```

---

## Приложение: Соответствие таблиц БД

| Таблица в боте | Таблица в panel | Назначение |
|----------------|-----------------|------------|
| `referrals` | `referrals` | Связь пользователей |
| `referral_rewards` | `referral_earnings` | История начислений |
| `partners` | `partners` | Профили партнеров |
| `partner_transactions` | `partner_referral_details` + `partner_earnings` | Начисления партнерам |
| `partner_withdrawals` | `partner_payouts` (нужно создать) | Выводы партнеров |
| `partner_referrals` | `partner_referral_details` | Рефералы партнеров |

---

*Документ создан автоматически на основе анализа исходного кода.*
